<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>After School Lessons</title>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/vue@2.7.10/dist/vue.js"></script>    
  /  <style>
        .course-card {
            margin: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 10px;
            text-align: center;
        }
        .course-image {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }
    </style>
</head>
<body>

<div id="app" class="container mt-5">
    <h1>Available Courses and Activities</h1>

    <div class="form-group">
        <label for="sortBy">Sort by:</label>
        <select v-model="sortKey" @change="sortLessons" class="form-control" id="sortBy">
            <option value="subject">Subject</option>
            <option value="location">Location</option>
            <option value="price">Price</option>
            <option value="space">Availability</option>
        </select>
    </div>
    <br>
    Order: 
    <button @click="toggleSortOrder">
        {{ sortOrder === 'asc' ? 'Ascending' : 'Descending'}}
    </button>

    <div v-if="showLessons" class="row">
        <div v-if="lessons.length ===0" class="col-12 text-center" >
            <p>Loading courses...</p>
        </div>
        <div class="col-md-4" v-for="lesson in sortedLessons" :key="lesson.subject">
            <div class="course-card">
                <img :src="lesson.image" alt="Course Image" class="course-image">
                <h5>{{ lesson.subject }}</h5>
                <p>Location: {{ lesson.location }}</p>
                <p>Price: ${{ lesson.price }}</p>
                <p>Available: {{ lesson.space }}</p>
                <button 
                    @click="addToCart(lesson)" 
                    :disabled="lesson.space === 0" 
                    class="btn btn-primary"
                >
                    {{ lesson.space === 0 ? 'Full' : 'Add to Cart' }}
                </button>
            </div>
        </div>
    </div>

    <div v-if="cart.length > 0">
        <button @click="toggleCart" class="btn btn-secondary mt-4">
            {{ showCart ? 'Go Back' : 'View Cart' }}
        </button>
    </div>

    <div v-if="showCart">
        <h2 class="mt-4">Shopping Cart</h2>
        <ul class="list-group">
            <li class="list-group-item" v-for="(item, index) in cart" :key="item.subject">
                {{ item.subject }} - ${{ item.price }}
                <button @click="removeFromCart(index)" class="btn btn-danger float-right">Remove</button>
            </li>
        </ul>
        <h3>Checkout</h3>
        <input v-model="customerName" placeholder="Name" class="form-control" />
        <p v-if="!isNameValid" class="text-danger">Name must only contain letters and spaces.</p>
        <input v-model="customerPhone" placeholder="Phone" class="form-control" />
        <p v-if="!isPhoneValid" class="text-danger">Phone number must be 10 digits.</p>
    
        <button @click="checkout":disabled="!isCheckoutEnabled" class="btn btn-success mt-2" >
            Checkout
        </button>
    </div>
</div>

<script>
new Vue({
    el: '#app',
    data: {
        lessons: [], //fetched dynamically
        cart: [],
        sortKey: 'subject',
        sortOrder: 'asc',
        showLessons: true,
        showCart: false,
        customerName: '',
        customerPhone: ''
    },
    computed: {
        sortedLessons: function() {
            return this.lessons.slice().sort((a, b) => {
                if (this.sortOrder === 'asc') {
                    return a[this.sortKey] > b[this.sortKey] ? 1 : -1;
                } else {
                    return a[this.sortKey] < b[this.sortKey] ? 1 : -1;
                }
            });
        },
        isNameValid() {
            const nameRegex = /^[a-zA-Z\s]+$/; 
            return nameRegex.test(this.customerName);
        },
        isPhoneValid() {
            const phoneRegex = /^\d{10}$/; 
            return phoneRegex.test(this.customerPhone);
        },
        isCheckoutEnabled() {
            return this.isNameValid && 
                   this.isPhoneValid && 
                   this.cart.length > 0;
        }
    },
    methods: {
        sortLessons() {
            this.lessons.sort((a, b) => {
                if (this.sortOrder === 'asc') {
                    return a[this.sortKey] > b[this.sortKey] ? 1 : -1;
                } else {
                    return a[this.sortKey] < b[this.sortKey] ? 1 : -1;
                }
            });
        },
        toggleSortOrder() {
            this.sortOrder = this.sortOrder === 'asc' ? 'desc' : 'asc';
            this.sortLessons();
        },
        addToCart(lesson) {
            // Create a copy to avoid direct mutation
            const lessonToAdd = {...lesson};
            this.cart.push(lessonToAdd);
            
            // Find and update the lesson in the original array
            const foundLesson = this.lessons.find(l => l._id === lesson._id);
            if (foundLesson) {
                foundLesson.space--;
            }
        },
        removeFromCart(index) {
            const removedLesson = this.cart.splice(index, 1)[0];
            
            // Find and update the lesson in the original array
            const foundLesson = this.lessons.find(l => l._id === removedLesson._id);
            if (foundLesson) {
                foundLesson.space++;
            }
        },
        toggleCart() {
            this.showLessons = !this.showLessons;
            this.showCart = !this.showCart;
        },
        checkout() {
            // Validate before proceeding
            if (!this.isCheckoutEnabled) {
                alert('Please fill in valid name and phone number');
                return;
            }

            const orderDetails = {
                name: this.customerName,
                phoneNumber: this.customerPhone,
                lessonIDs: this.cart.map(lesson => lesson._id),
                quantity: this.cart.length
            };

            fetch('http://localhost:5001/api/orders', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(orderDetails)
            })
            .then(response => {
                console.log('Checkout response status:', response.status);
                if (!response.ok) {
                    return response.json().then(err => { throw err; });
                }
                return response.json();
            })
            .then(data => {
                alert('Order placed successfully!');
                // Reset cart and view
                this.cart = [];
                this.showCart = false;
                this.showLessons = true;
                this.customerName = '';
                this.customerPhone = '';
            })
            .catch(error => {
                console.error('Checkout error:', error);
                alert('Failed to place order: ' + 
                    (error.message || 'Unknown error occurred')
                );
            });
        }
    },
    created() {
        // Fetch lessons dynamically from back-end
        fetch('http://localhost:5001/api/lessons/products')
            .then(response => {
                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Received data:', data);
                this.lessons = data; // Populate lessons
            })
            .catch(error => {
                console.error('Full error fetching lessons:', error);
                alert('Failed to load courses: ' + error.message);
            });
    }
});
</script>
</body>
</html>