<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>After School Lessons</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div id="app" class="container mt-5">
    <h1>After School Lessons</h1>

    <!-- Search and Sort Controls -->
    <div class="row mb-3">
        <div class="col-md-6">
            <input 
                v-model="searchTerm" 
                type="text" 
                placeholder="Search lessons" 
                class="form-control"
            >
        </div>
        <div class="col-md-3">
            <select v-model="sortBy" class="form-select">
                <option value="name">Sort by Name</option>
                <option value="price">Sort by Price</option>
            </select>
        </div>
        <div class="col-md-3">
            <select v-model="sortOrder" class="form-select">
                <option value="asc">Ascending</option>
                <option value="desc">Descending</option>
            </select>
        </div>
    </div>

    <!-- Lessons List -->
    <div class="row" v-if="!showCart">
        <div 
            v-for="lesson in filteredAndSortedLessons" 
            :key="lesson._id" 
            class="col-md-4 mb-3"
        >
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">{{ lesson.name }}</h5>
                    <p class="card-text">{{ lesson.description }}</p>
                    <p>Price: ${{ lesson.price }}</p>
                    <p>Available: {{ lesson.available ? 'Yes' : 'No' }}</p>
                    <button 
                        @click="addToCart(lesson)" 
                        class="btn btn-primary"
                        :disabled="!lesson.available"
                    >
                        Add to Cart
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Cart View -->
    <div v-else>
        <h2>Shopping Cart</h2>
        <div v-for="(item, index) in cart" :key="index" class="card mb-2">
            <div class="card-body">
                <h5>{{ item.name }}</h5>
                <p>Price: ${{ item.price }}</p>
                <button 
                    @click="removeFromCart(index)" 
                    class="btn btn-danger"
                >
                    Remove
                </button>
            </div>
        </div>

        <!-- Checkout Form -->
        <div class="mt-4">
            <input 
                v-model="customerName" 
                type="text" 
                placeholder="Your Name" 
                class="form-control mb-2"
            >
            <input 
                v-model="phoneNumber" 
                type="tel" 
                placeholder="Phone Number (10 digits)" 
                class="form-control mb-2"
            >
            <button 
                @click="checkout" 
                class="btn btn-success"
                :disabled="!isCheckoutValid"
            >
                Checkout
            </button>
        </div>
    </div>

    <!-- Cart Toggle Button -->
    <button 
        @click="showCart = !showCart" 
        class="btn btn-secondary mt-3"
    >
        {{ showCart ? 'Back to Lessons' : 'View Cart' }}
    </button>
</div>

<script>
const { createApp, ref, computed } = Vue

createApp({
    data() {
        return {
            lessons: [],
            cart: [],
            searchTerm: '',
            sortBy: 'name',
            sortOrder: 'asc',
            showCart: false,
            customerName: '',
            phoneNumber: ''
        }
    },
    computed: {
        filteredAndSortedLessons() {
            let result = this.lessons

            // Search filter
            if (this.searchTerm) {
                const term = this.searchTerm.toLowerCase()
                result = result.filter(lesson => 
                    lesson.name.toLowerCase().includes(term) ||
                    lesson.description.toLowerCase().includes(term)
                )
            }

            // Sorting
            return result.sort((a, b) => {
                const modifier = this.sortOrder === 'asc' ? 1 : -1
                return (a[this.sortBy] > b[this.sortBy] ? 1 : -1) * modifier
            })
        },
        isCheckoutValid() {
            const nameValid = /^[a-zA-Z\s]+$/.test(this.customerName)
            const phoneValid = /^\d{10}$/.test(this.phoneNumber)
            return nameValid && phoneValid && this.cart.length > 0
        }
    },
    methods: {
        async fetchLessons() {
            try {
                const response = await fetch('http://localhost:5001/api/lessons/products')
                this.lessons = await response.json()
            } catch (error) {
                console.error('Failed to fetch lessons:', error)
            }
        },
        addToCart(lesson) {
            this.cart.push(lesson)
        },
        removeFromCart(index) {
            this.cart.splice(index, 1)
        },
        async checkout() {
            if (!this.isCheckoutValid) return

            try {
                const response = await fetch('http://localhost:5001/api/lessons/orders', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: this.customerName,
                        phoneNumber: this.phoneNumber,
                        lessonIDs: this.cart.map(lesson => lesson._id),
                        quantity: this.cart.length
                    })
                })

                const result = await response.json()

                if (response.ok) {
                    alert('Order placed successfully!')
                    this.cart = []
                    this.customerName = ''
                    this.phoneNumber = ''
                    this.showCart = false
                } else {
                    alert(result.message || 'Order failed')
                }
            } catch (error) {
                console.error('Checkout error:', error)
                alert('Failed to place order')
            }
        }
    },
    mounted() {
        this.fetchLessons()
    }
}).mount('#app')
</script>
</body>
</html>